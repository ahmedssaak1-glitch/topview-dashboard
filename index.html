<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TOP VIEW — Management (EN/AR)</title>

  <!-- PWA meta -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1f78ff"/>
  <meta name="apple-mobile-web-app-capable" content="yes">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --accent:#1f78ff;
      --muted:#6b7280;
      --bg:#f6f7fb;
      --card:#ffffff;
      --glass: rgba(255,255,255,0.95);
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Arial; margin:0; background:var(--bg); color:#0f172a; direction:ltr}
    a{color:inherit}
    header{padding:12px 16px; background:#fff; border-bottom:1px solid #eef2f7; display:flex;align-items:center;gap:12px}
    .brand{font-weight:800;color:var(--accent);font-size:18px}
    .lang-toggle{margin-left:auto; display:flex; gap:8px; align-items:center}
    .container{padding:16px}
    .app{display:flex; gap:12px; min-height:calc(100vh - 56px)}
    .sidebar{width:260px; background:linear-gradient(180deg,#fff,#fbfcff); border-right:1px solid #eef2f7; padding:14px; display:flex; flex-direction:column; gap:12px}
    .nav button{display:block;padding:10px;border-radius:8px;border:0;background:transparent;text-align:left;width:100%;cursor:pointer;font-weight:600}
    .nav button.active{background:#f1f6ff;color:var(--accent)}
    .main{flex:1; padding:12px}
    .card{background:var(--card); padding:12px; border-radius:12px; box-shadow:0 6px 20px rgba(2,6,23,0.04)}
    .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:12px}
    .stat{padding:12px;border-radius:10px;background:var(--card)}
    table{width:100%; border-collapse:collapse; font-size:14px; margin-top:10px}
    th,td{padding:10px 12px; border-bottom:1px solid #f3f6fa; text-align:left}
    th{background:#fafbff;color:var(--muted);font-weight:700}
    input, select, textarea{width:100%; padding:10px;border-radius:8px;border:1px solid #e6e9ef; margin:6px 0}
    .row{display:flex; gap:10px}
    .row .col{flex:1}
    .btn{padding:10px 12px;border-radius:8px;border:0;background:var(--accent); color:#fff; cursor:pointer}
    .btn.ghost{background:transparent;color:var(--muted);border:1px solid rgba(15,23,42,0.06)}
    .small{font-size:13px;color:var(--muted)}
    .file-list{display:flex;flex-direction:column;gap:8px}
    .file-item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;background:#fbfdff;border:1px solid #eef4ff}
    .file-thumb{width:56px;height:40px;background:#eef5ff;border-radius:6px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .progress{height:8px;background:#eef4ff;border-radius:6px;overflow:hidden}
    .progress > b{display:block;height:100%;background:var(--accent);width:0%}
    .locale-ar { direction: rtl; }
    @media (max-width:900px){ .sidebar{display:none} .grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:600px){ .grid{grid-template-columns:1fr} table, th, td {font-size:13px} }

    /* Accessibility + safety */
    .overlay, .backdrop, .modal-backdrop, [data-overlay] { pointer-events: none !important; z-index: 1 !important; }
    input, textarea, select { color:#0b1220 !important; background:#fff !important; caret-color:#0b1220 !important; }
  </style>
</head>
<body>
  <header>
    <div class="brand" id="brand">TOP VIEW</div>
    <div class="small" id="subtitle">Interior Fit-out — Management</div>

    <div class="lang-toggle" role="navigation" aria-label="Language">
      <label for="lang">EN</label>
      <select id="lang">
        <option value="en" selected>English</option>
        <option value="ar">العربية</option>
      </select>
    </div>

    <div id="user-controls" style="margin-left:12px"></div>
  </header>

  <main class="container">
    <div id="root"></div>
  </main>

  <!-- Firebase modular imports -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";

  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

  import {
    getFirestore,
    collection,
    addDoc,
    setDoc,
    doc,
    deleteDoc,
    updateDoc,
    query,
    where,
    orderBy,
    limit,
    onSnapshot,
    getDocs,
    enableIndexedDbPersistence,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  import {
    getStorage,
    ref as storageRef,
    uploadBytesResumable,
    getDownloadURL,
    deleteObject
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

  // -----------------------
  // CONFIG - paste your Firebase config here (keeps the one you provided)
  // -----------------------
  const firebaseConfig = {
    apiKey: "AIzaSyCEpRw7F829fqzPZAphqJ2wOe3xUDJWLtw",
    authDomain: "topview-system.firebaseapp.com",
    projectId: "topview-system",
    storageBucket: "topview-system.firebasestorage.app",
    messagingSenderId: "1073945877413",
    appId: "1:1073945877413:web:d516e451e543f7a9db664c",
    measurementId: "G-EPVZGH6Y2G"
  };

  const fbApp = initializeApp(firebaseConfig);
  try{ getAnalytics(fbApp); }catch(e){ /* optional */ }
  const auth = getAuth(fbApp);
  const db = getFirestore(fbApp);
  const storage = getStorage(fbApp);

  // try enable offline persistence
  try{
    enableIndexedDbPersistence(db).catch(err=>{
      console.warn('Persistence error', err);
    });
  }catch(e){ console.warn('enableIndexedDbPersistence not available', e); }

  // -----------------------
  // i18n (English primary, Arabic support)
  // -----------------------
  const i18n = {
    en: {
      brand: 'TOP VIEW',
      subtitle: 'Interior Fit-out — Management',
      login: 'Login',
      signup: 'Sign up',
      demo: 'Create demo data',
      email: 'Email',
      password: 'Password',
      dashboard: 'Dashboard',
      employees: 'Employees',
      projects: 'Projects',
      finance: 'Finance',
      attendance: 'Attendance',
      settings: 'Settings',
      addEmployee: 'Add Employee',
      addProject: 'New Project',
      addTransaction: 'Add Transaction',
      recordIn: 'Record In (me)',
      recordOut: 'Record Out (me)',
      attachments: 'Attachments',
      upload: 'Upload',
      chooseFiles: 'Choose files',
      allowedTypesNote: 'Images, PDF, Word, Excel, ZIP. Max size: 20MB',
      logout: 'Logout'
    },
    ar: {
      brand: 'توب فيو',
      subtitle: 'إدارة الديكور الداخلي',
      login: 'دخول',
      signup: 'تسجيل',
      demo: 'إنشاء بيانات تجريبية',
      email: 'البريد الإلكتروني',
      password: 'كلمة المرور',
      dashboard: 'لوحة التحكم',
      employees: 'الموظفون',
      projects: 'المشاريع',
      finance: 'المالية',
      attendance: 'الحضور',
      settings: 'الإعدادات',
      addEmployee: 'إضافة موظف',
      addProject: 'مشروع جديد',
      addTransaction: 'إضافة معاملة',
      recordIn: 'تسجيل حضور (دخول)',
      recordOut: 'تسجيل خروج (خروج)',
      attachments: 'المرفقات',
      upload: 'رفع',
      chooseFiles: 'اختر ملفات',
      allowedTypesNote: 'صور، PDF، Word، Excel، ZIP. الحد الأقصى: 20ميجا',
      logout: 'خروج'
    }
  };

  let lang = localStorage.getItem('topview_lang') || 'en';
  document.getElementById('lang').value = lang;
  applyLanguage();

  document.getElementById('lang').addEventListener('change', (e)=>{
    lang = e.target.value;
    localStorage.setItem('topview_lang', lang);
    applyLanguage();
    renderCurrentView();
  });

  function t(key){ return (i18n[lang] && i18n[lang][key]) || i18n['en'][key] || key; }
  function applyLanguage(){
    document.getElementById('brand').textContent = t('brand');
    document.getElementById('subtitle').textContent = t('subtitle');
    document.documentElement.lang = lang === 'ar' ? 'ar' : 'en';
    document.body.classList.toggle('locale-ar', lang==='ar');
  }

  // -----------------------
  // DOM helpers & state
  // -----------------------
  const root = document.getElementById('root');
  function el(tag, attrs={}, ...kids){
    const n = document.createElement(tag);
    for(const k in attrs){
      if(k === 'class') n.className = attrs[k];
      else if(k === 'html') n.innerHTML = attrs[k];
      else n.setAttribute(k, attrs[k]);
    }
    kids.forEach(c=> { if(typeof c === 'string') n.appendChild(document.createTextNode(c)); else if(c) n.appendChild(c); });
    return n;
  }

  // state (will be kept in-memory and updated via onSnapshot)
  const state = {
    users: [],
    projects: [],
    transactions: [],
    attendance: [],
    attachments: []
  };

  // -----------------------
  // Real-time listeners (onSnapshot)
  // -----------------------
  function attachRealtimeListeners(){
    // users
    onSnapshot(collection(db,'users'), snap=>{
      state.users = snap.docs.map(d=> ({ id: d.id, ...d.data() }));
      renderCurrentView(); // update UI
    });
    // projects
    onSnapshot(collection(db,'projects'), snap=>{
      state.projects = snap.docs.map(d=> ({ id: d.id, ...d.data() }));
      renderCurrentView();
    });
    // transactions
    onSnapshot(collection(db,'transactions'), snap=>{
      state.transactions = snap.docs.map(d=> ({ id: d.id, ...d.data() }));
      renderCurrentView();
    });
    // attendance
    onSnapshot(collection(db,'attendance'), snap=>{
      state.attendance = snap.docs.map(d=> ({ id: d.id, ...d.data() }));
      renderCurrentView();
    });
    // attachments
    onSnapshot(collection(db,'attachments'), snap=>{
      state.attachments = snap.docs.map(d=> ({ id: d.id, ...d.data() }));
      renderCurrentView();
    });
  }

  // -----------------------
  // File upload utilities
  // -----------------------
  const MAX_SIZE = 20 * 1024 * 1024; // 20MB default, can change
  const ALLOWED = [ // used for UI note only; we accept all mime but validate size
    'image/', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/zip'
  ];

  function isAllowedMime(mime){
    if(!mime) return true; // accept unknown but size-limited
    return ALLOWED.some(a => mime.startsWith(a));
  }

  async function uploadFile(file, relatedType = 'project', relatedId = null, uploadedBy = null){
    if(file.size > MAX_SIZE) throw new Error('File too large: ' + file.name);
    if(!isAllowedMime(file.type)){
      // allow but warn; here we still let it pass — change to reject if desired
      console.warn('File mime not in recommended list', file.type);
    }

    const path = `attachments/${Date.now()}_${Math.random().toString(36).slice(2,8)}_${file.name.replace(/\s+/g,'_')}`;
    const sRef = storageRef(storage, path);
    const uploadTask = uploadBytesResumable(sRef, file, { contentType: file.type });

    // return a promise that resolves with metadata and downloadURL + storagePath
    return new Promise((resolve, reject)=>{
      uploadTask.on('state_changed', (snap)=>{
        // progress can be observed externally via event or callback if needed
      }, (err)=> reject(err), async ()=>{
        try{
          const url = await getDownloadURL(uploadTask.snapshot.ref);
          const meta = {
            filename: file.name,
            contentType: file.type,
            size: file.size,
            storagePath: path,
            url,
            uploadedBy: uploadedBy || (auth.currentUser ? auth.currentUser.uid : null),
            uploadedAt: serverTimestamp(),
            relatedType,
            relatedId
          };
          const docRef = await addDoc(collection(db,'attachments'), meta);
          resolve({ id: docRef.id, ...meta });
        }catch(e){ reject(e); }
      });
    });
  }

  async function deleteAttachment(att){
    try{
      if(att.storagePath){
        const delRef = storageRef(storage, att.storagePath);
        await deleteObject(delRef).catch(e => console.warn('storage delete error', e));
      }
      await deleteDoc(doc(db,'attachments', att.id));
    }catch(e){ throw e; }
  }

  // -----------------------
  // UI Views & Components
  // -----------------------
  let currentPage = 'Dashboard';
  function buildSidebar(){
    const sidebar = el('div',{class:'sidebar'});
    sidebar.appendChild(el('div',{class:'small'}, t('brand') + ' — ' + t('subtitle')));
    const nav = el('div',{class:'nav'});
    const pages = [
      { key: 'Dashboard', title: t('dashboard') },
      { key: 'Employees', title: t('employees') },
      { key: 'Projects', title: t('projects') },
      { key: 'Finance', title: t('finance') },
      { key: 'Attendance', title: t('attendance') },
      { key: 'Attachments', title: t('attachments') },
      { key: 'Settings', title: t('settings') }
    ];
    pages.forEach(p=>{
      const b = el('button',{}, p.title);
      if(currentPage === p.key) b.classList.add('active');
      b.onclick = ()=>{ currentPage = p.key; renderCurrentView(); };
      nav.appendChild(b);
    });
    sidebar.appendChild(nav);
    return sidebar;
  }

  function renderDashboard(main){
    const inc = state.transactions.filter(t=>t.type === 'Income').reduce((s,t)=>s+(t.amount||0),0);
    const exp = state.transactions.filter(t=>t.type === 'Expense').reduce((s,t)=>s+(t.amount||0),0);
    const profit = inc - exp;
    const grid = el('div',{class:'grid'});
    grid.appendChild(el('div',{class:'stat'}, el('div',{class:'small'}, t('dashboard')), el('div',{style:'font-weight:700;font-size:18px'}, `${inc} AED`)));
    grid.appendChild(el('div',{class:'stat'}, el('div',{class:'small'}, t('finance')), el('div',{style:'font-weight:700;font-size:18px'}, `${exp} AED`)));
    grid.appendChild(el('div',{class:'stat'}, el('div',{class:'small'}, 'Profit'), el('div',{style:'font-weight:700;font-size:18px'}, `${profit} AED`)));
    main.appendChild(grid);

    main.appendChild(el('h3',{}, t('projects')));
    const projectsTable = el('div',{}, buildProjectsTable());
    main.appendChild(projectsTable);
  }

  function buildProjectsTable(){
    const wrap = el('div',{class:'card'});
    const table = el('table');
    table.appendChild(el('thead',{}, el('tr',{}, el('th',{}, 'Name'), el('th',{}, 'Client'), el('th',{}, 'Status'), el('th',{}, 'Budget'))));
    const tb = el('tbody');
    state.projects.forEach(p=>{
      const tr = el('tr');
      tr.appendChild(el('td',{}, p.name));
      tr.appendChild(el('td',{}, p.client || '-'));
      tr.appendChild(el('td',{}, p.status || '-'));
      tr.appendChild(el('td',{}, (p.budget || 0) + ' AED'));
      tb.appendChild(tr);
    });
    table.appendChild(tb);
    wrap.appendChild(table);
    wrap.appendChild(el('div',{style:'margin-top:8px;display:flex;gap:8px'}, el('button',{class:'btn', onclick: openAddProject}, t('addProject'))));
    return wrap;
  }

  function renderEmployees(main){
    main.appendChild(el('h3',{}, t('employees')));
    main.appendChild(buildEmployeesTable());
    main.appendChild(el('div',{style:'margin-top:12px'}, el('button',{class:'btn', onclick: openAddEmployee}, t('addEmployee'))));
  }

  function buildEmployeesTable(){
    const wrap = el('div',{class:'card'});
    const table = el('table');
    table.appendChild(el('thead',{}, el('tr',{}, el('th',{}, 'Name'), el('th',{}, 'Role'), el('th',{}, 'Salary'), el('th',{}, 'Email'), el('th',{}, 'Actions'))));
    const tb = el('tbody');
    state.users.forEach(u=>{
      const tr = el('tr');
      tr.appendChild(el('td',{}, u.name || '-'));
      tr.appendChild(el('td',{}, u.role || '-'));
      tr.appendChild(el('td',{}, (u.salary||0) + ' AED'));
      tr.appendChild(el('td',{}, u.email || '-'));
      const action = el('td',{});
      const attachBtn = el('button',{class:'btn ghost'}, 'Attach file');
      attachBtn.onclick = ()=> openUploadModal('user', u.id);
      action.appendChild(attachBtn);
      tb.appendChild(tr);
      tr.appendChild(action);
    });
    table.appendChild(tb);
    wrap.appendChild(table);
    return wrap;
  }

  function renderFinance(main){
    main.appendChild(el('h3',{}, t('finance')));
    main.appendChild(buildTransactionsTable());
    main.appendChild(el('div',{style:'margin-top:12px'}, el('button',{class:'btn', onclick: openAddTransaction}, t('addTransaction'))));
  }

  function buildTransactionsTable(){
    const wrap = el('div',{class:'card'});
    const table = el('table');
    table.appendChild(el('thead',{}, el('tr',{}, el('th',{}, 'Type'), el('th',{}, 'Category'), el('th',{}, 'Amount'), el('th',{}, 'Date'), el('th',{}, 'Attachments'))));
    const tb = el('tbody');
    state.transactions.forEach(tn=>{
      const tr = el('tr');
      tr.appendChild(el('td',{}, tn.type));
      tr.appendChild(el('td',{}, tn.category));
      tr.appendChild(el('td',{}, (tn.amount||0) + ' AED'));
      tr.appendChild(el('td',{}, tn.date));
      const attTd = el('td',{});
      const rel = state.attachments.filter(a => a.relatedType === 'transaction' && a.relatedId === tn.id);
      if(rel.length) rel.forEach(a => {
        const aEl = el('div',{}, el('a',{href:a.url, target:'_blank'}, a.filename));
        attTd.appendChild(aEl);
      }) ;
      tr.appendChild(attTd);
      tb.appendChild(tr);
    });
    table.appendChild(tb);
    wrap.appendChild(table);
    return wrap;
  }

  function renderAttendance(main){
    main.appendChild(el('h3',{}, t('attendance')));
    main.appendChild(el('div',{style:'display:flex;gap:8px;align-items:center'}, el('button',{class:'btn', onclick: recordIn}, t('recordIn')), el('button',{class:'btn ghost', onclick: recordOut}, t('recordOut'))));
    main.appendChild(buildAttendanceTable());
  }

  function buildAttendanceTable(){
    const wrap = el('div',{class:'card'});
    const table = el('table');
    table.appendChild(el('thead',{}, el('tr',{}, el('th',{}, 'Employee'), el('th',{}, 'Date'), el('th',{}, 'In'), el('th',{}, 'Out'))));
    const tb = el('tbody');
    state.attendance.slice().reverse().forEach(a=>{
      const u = state.users.find(x => x.uid === a.uid) || state.users.find(x => x.id === a.userId) || { name: a.name || '—' };
      const tr = el('tr');
      tr.appendChild(el('td',{}, u.name || '-'));
      tr.appendChild(el('td',{}, a.date));
      tr.appendChild(el('td',{}, a.in || '-'));
      tr.appendChild(el('td',{}, a.out || '-'));
      tb.appendChild(tr);
    });
    table.appendChild(tb); wrap.appendChild(table);
    return wrap;
  }

  function renderAttachments(main){
    main.appendChild(el('h3',{}, t('attachments')));
    main.appendChild(buildAttachmentsPanel());
  }

  function buildAttachmentsPanel(){
    const wrap = el('div',{class:'card'});
    // upload form
    const form = el('div',{style:'display:flex;gap:8px;flex-direction:column'});
    form.appendChild(el('label',{}, t('chooseFiles')));
    const fileInput = el('input',{type:'file', multiple:'', accept:'*/*'});
    form.appendChild(fileInput);
    form.appendChild(el('div',{class:'small'}, t('allowedTypesNote')));
    // related select
    const relType = el('select',{}, el('option',{value:'project'}, 'Project'), el('option',{value:'transaction'}, 'Transaction'), el('option',{value:'user'}, 'User'));
    const relId = el('select',{}, el('option',{value:''}, '— select —'));
    form.appendChild(el('div',{style:'display:flex;gap:8px'}, relType, relId));
    // fill relId options dynamically
    function fillRelOptions(){
      relId.innerHTML = '';
      const type = relType.value;
      let list = [];
      if(type === 'project') list = state.projects;
      if(type === 'transaction') list = state.transactions;
      if(type === 'user') list = state.users;
      relId.appendChild(el('option',{value:''}, '— select —'));
      list.forEach(i => relId.appendChild(el('option',{value:i.id}, i.name || i.filename || i.client || i.email || i.username)));
    }
    relType.onchange = fillRelOptions;
    fillRelOptions();

    const uploadBtn = el('button',{class:'btn'}, t('upload'));
    const uploadStatus = el('div',{class:'file-list'});
    uploadBtn.onclick = async ()=>{
      const files = Array.from(fileInput.files || []);
      if(!files.length) return alert('No files selected');
      const type = relType.value || 'project';
      const id = relId.value || null;
      for(const f of files){
        // create a UI card to show progress
        const item = el('div',{class:'file-item'});
        const thumb = el('div',{class:'file-thumb'}, f.type.startsWith('image/') ? el('img',{src:URL.createObjectURL(f), style:'width:100%;height:100%;object-fit:cover'}) : el('span',{}, f.name.split('.').pop().toUpperCase()));
        const meta = el('div',{}, el('div',{}, f.name), el('div',{class:'small'}, (f.size/1024|0) + ' KB'));
        const prog = el('div',{class:'progress'}, el('b',{style:'width:0%'}));
        item.appendChild(thumb); item.appendChild(meta); item.appendChild(prog);
        uploadStatus.appendChild(item);

        try{
          // hand uploadFile handles adding DB doc
          const res = await uploadFileWithProgress(f, type, id, (p)=> { prog.firstChild.style.width = (p*100|0) + '%'; } );
          // replace meta with link
          meta.innerHTML = '';
          const link = el('a',{href:res.url, target:'_blank'}, res.filename);
          meta.appendChild(link);
          meta.appendChild(el('div',{class:'small'}, res.contentType || ''));
        }catch(e){
          meta.appendChild(el('div',{class:'small'}, 'Upload error: ' + (e.message||e)));
        }
      }
      fileInput.value = '';
    };

    form.appendChild(uploadBtn);
    form.appendChild(uploadStatus);
    wrap.appendChild(form);

    // list existing attachments
    wrap.appendChild(el('h4',{}, 'All Attachments'));
    const list = el('div',{class:'file-list'});
    state.attachments.forEach(a=>{
      const row = el('div',{class:'file-item'});
      const thumb = el('div',{class:'file-thumb'}, a.contentType && a.contentType.startsWith('image/') ? el('img',{src:a.url, style:'width:100%;height:100%;object-fit:cover'}) : el('span',{}, a.filename.split('.').pop().toUpperCase()));
      row.appendChild(thumb);
      const info = el('div',{}, el('div',{}, a.filename), el('div',{class:'small'}, `${a.relatedType || '-'} ${a.relatedId || ''}`));
      row.appendChild(info);
      const actions = el('div',{style:'margin-left:auto;display:flex;gap:8px;align-items:center'});
      const dl = el('a',{href:a.url, target:'_blank', class:'btn'}, 'Open');
      const del = el('button',{class:'btn ghost'}, 'Delete');
      del.onclick = async ()=> {
        if(!confirm('Delete attachment?')) return;
        try{ await deleteAttachment(a); alert('Deleted'); }catch(e){ alert('Error: ' + e.message); }
      };
      actions.appendChild(dl); actions.appendChild(del);
      row.appendChild(actions);
      list.appendChild(row);
    });
    wrap.appendChild(list);

    return wrap;
  }

  // Helper upload with progress callbacks
  function uploadFileWithProgress(file, relatedType, relatedId, onProgress){
    // create storage ref and use uploadBytesResumable directly here to provide progress
    if(file.size > MAX_SIZE) return Promise.reject(new Error('File too large'));
    const path = `attachments/${Date.now()}_${Math.random().toString(36).slice(2,8)}_${file.name.replace(/\s+/g,'_')}`;
    const sRef = storageRef(storage, path);
    const uploadTask = uploadBytesResumable(sRef, file, { contentType: file.type });
    return new Promise((resolve, reject)=>{
      uploadTask.on('state_changed', (snap)=>{
        const pct = snap.totalBytes ? snap.bytesTransferred / snap.totalBytes : 0;
        if(typeof onProgress === 'function') onProgress(pct);
      }, (err)=> reject(err), async ()=>{
        try{
          const url = await getDownloadURL(uploadTask.snapshot.ref);
          const meta = {
            filename: file.name,
            contentType: file.type,
            size: file.size,
            storagePath: path,
            url,
            uploadedBy: auth.currentUser ? auth.currentUser.uid : null,
            uploadedAt: serverTimestamp(),
            relatedType,
            relatedId
          };
          const docRef = await addDoc(collection(db,'attachments'), meta);
          resolve({ id: docRef.id, ...meta });
        }catch(e){ reject(e); }
      });
    });
  }

  // -----------------------
  // CRUD actions (prompts for simplicity)
  // -----------------------
  async function openAddEmployee(){
    const name = prompt('Full name'); if(!name) return;
    const email = prompt('Email (used for login)'); if(!email) return;
    const role = prompt('Role','Worker');
    const salary = Number(prompt('Salary AED','3000')||3000);
    try{
      const res = await createUserWithEmailAndPassword(auth, email.trim(), 'pass123');
      // store user doc with uid as field and optionally as document id (could map later)
      await addDoc(collection(db,'users'), { name, email: email.trim(), role, salary, uid: res.user.uid, username: email.split('@')[0] });
      alert('Employee added. default password: pass123');
    }catch(e){ alert('Error: ' + (e.message || e)); }
  }

  async function openAddProject(){
    const name = prompt('Project name'); if(!name) return;
    const client = prompt('Client'); const budget = Number(prompt('Budget AED','10000')||10000);
    await addDoc(collection(db,'projects'), { name, client, budget, status: 'Planned', engineer: '' });
    alert('Project added');
  }

  async function openAddTransaction(){
    const type = prompt('Type: Expense or Income','Expense'); if(!type) return;
    const category = prompt('Category','Materials'); const amount = Number(prompt('Amount AED','1000')||1000);
    await addDoc(collection(db,'transactions'), { type, category, amount, date: (new Date()).toISOString().slice(0,10), note: '' });
    alert('Transaction added');
  }

  async function recordIn(){
    const user = auth.currentUser;
    if(!user) return alert('Not signed in');
    await addDoc(collection(db,'attendance'), { uid: user.uid, date: (new Date()).toISOString().slice(0,10), in: (new Date()).toLocaleTimeString(), out: '' });
    alert('Check-in recorded');
  }

  async function recordOut(){
    const user = auth.currentUser;
    if(!user) return alert('Not signed in');
    const q = query(collection(db,'attendance'), where('uid','==', user.uid), where('date','==', (new Date()).toISOString().slice(0,10)), where('out','==',''));
    const snap = await getDocs(q);
    if(snap.empty) return alert('No check-in found');
    const last = snap.docs[snap.docs.length - 1];
    await updateDoc(doc(db,'attendance', last.id), { out: (new Date()).toLocaleTimeString() });
    alert('Check-out recorded');
  }

  // -----------------------
  // Attach simple header controls for auth
  // -----------------------
  function renderAuthControls(userDoc){
    const container = document.getElementById('user-controls');
    container.innerHTML = '';
    if(!userDoc){
      const btnLogin = el('button',{class:'btn ghost'}, t('login'));
      btnLogin.onclick = ()=> showLogin();
      const btnDemo = el('button',{class:'btn'}, t('demo'));
      btnDemo.onclick = seedDemoData;
      container.appendChild(btnDemo); container.appendChild(btnLogin);
      return;
    }
    const name = userDoc.name || userDoc.email || 'User';
    container.appendChild(el('span',{class:'small'}, name));
    const btnOut = el('button',{class:'btn ghost', style:'margin-left:8px'}, t('logout'));
    btnOut.onclick = ()=> signOut(auth);
    container.appendChild(btnOut);
  }

  // -----------------------
  // Render main SPA: assemble sidebar + main
  // -----------------------
  function renderCurrentView(){
    root.innerHTML = '';
    const app = el('div',{class:'app'});
    const sidebar = buildSidebar();
    const main = el('div',{class:'main'});
    app.appendChild(sidebar); app.appendChild(main);
    root.appendChild(app);

    // render based on currentPage
    switch(currentPage){
      case 'Employees': renderEmployees(main); break;
      case 'Projects': main.appendChild(buildProjectsTable()); break;
      case 'Finance': renderFinance(main); break;
      case 'Attendance': renderAttendance(main); break;
      case 'Attachments': renderAttachments(main); break;
      case 'Settings': main.appendChild(el('div',{class:'card'}, el('h3',{}, t('settings')), el('p',{}, 'Company: TOP VIEW'))); break;
      default: renderDashboard(main); break;
    }
  }

  // -----------------------
  // Startup & auth handling
  // -----------------------
  let currentUserDoc = null;
  let currentUserAuth = null;
  let currentPage = 'Dashboard';

  onAuthStateChanged(auth, async (user)=>{
    currentUserAuth = user;
    if(!user){
      currentUserDoc = null;
      renderAuthControls(null);
      showLogin();
      attachRealtimeListeners(); // keep listening so managers can see updates even if not signed in? optional
      return;
    }
    // find or create user doc by uid
    try{
      const q = query(collection(db,'users'), where('uid','==', user.uid), limit(1));
      const snap = await getDocs(q);
      if(!snap.empty){
        currentUserDoc = { id: snap.docs[0].id, ...snap.docs[0].data() };
      }else{
        const docRef = await addDoc(collection(db,'users'), { name: user.displayName || user.email.split('@')[0], email: user.email, uid: user.uid, role: 'Worker', salary: 3000 });
        currentUserDoc = { id: docRef.id, name: user.displayName || user.email.split('@')[0], email: user.email, uid: user.uid, role: 'Worker', salary: 3000 };
      }
      renderAuthControls(currentUserDoc);
      attachRealtimeListeners();
      renderCurrentView();
    }catch(e){
      console.error(e);
      alert('Error loading user data: ' + (e.message || e));
      signOut(auth);
    }
  });

  // initial render: if not logged in show login
  showLogin();

  // register service worker for PWA (optional)
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('/sw.js').then(()=> console.log('SW registered')).catch(e=> console.warn('SW err', e));
  }
  </script>
</body>
</html>
