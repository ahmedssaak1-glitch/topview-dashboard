<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TopView â€” Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; margin:0; background:#f4f6fa; color:#222; }
.login-bg { background: url('https://images.unsplash.com/photo-1508120272534-9e2d58b7d1f2?auto=format&fit=crop&w=1400&q=80') center/cover no-repeat; position: fixed; top:0; left:0; width:100%; height:100%; filter: brightness(0.5); z-index:-1; }
.login-box { max-width:340px; background:#fff; padding:24px; border-radius:16px; margin:120px auto; box-shadow:0 4px 16px rgba(0,0,0,0.15);}
h2 { text-align:center; }
input { width:100%; padding:10px; margin:8px 0 14px; border:1px solid #ccc; border-radius:8px; font-size:14px; }
button { width:100%; padding:10px; border:none; border-radius:8px; background:#007bff; color:#fff; font-weight:600; cursor:pointer; font-size:15px; }
button:hover { background:#0056b3; }
.sidebar { width:220px; background:#fff; height:100vh; position:fixed; border-right:1px solid #ddd; padding-top:20px; }
.sidebar h3 { text-align:center; color:#007bff; margin-bottom:20px; }
.sidebar button { width:90%; margin:6px auto; display:block; background:none; color:#222; text-align:left; padding:10px 12px; border-radius:8px; transition:0.2s; cursor:pointer; }
.sidebar button.active, .sidebar button:hover { background:#007bff; color:#fff; }
main { margin-left:240px; padding:20px; }
.card { background:#fff; border-radius:12px; padding:16px; box-shadow:0 1px 4px rgba(0,0,0,0.1); }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { padding:10px; border-bottom:1px solid #eee; }
th { text-align:left; background:#f9fafb; }
tr:hover td { background:#f1f5ff; }
.btn { background:#007bff; color:#fff; padding:8px 14px; border-radius:8px; border:none; cursor:pointer; }
.btn:hover { background:#0056b3; }
.btn.ghost { background:#eee; color:#333; }
[contenteditable]:focus { outline:none; background:#e6ffe6; transition:0.4s; }
</style>
</head>
<body>
<div id="app"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCEpRw7F829fqzPZAphqJ2wOe3xUDJWLtw",
  authDomain: "topview-system.firebaseapp.com",
  projectId: "topview-system",
  storageBucket: "topview-system.firebasestorage.app",
  messagingSenderId: "1073945877413",
  appId: "1:1073945877413:web:d516e451e543f7a9db664c",
  measurementId: "G-EPVZGH6Y2G"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const state = { user:null, page:'clients', clients:[], attendance:[], costs:[] };
const app = document.getElementById('app');

function el(tag, attrs={}, ...children){
  const e = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs)){
    if(k.startsWith('on')) e.addEventListener(k.substring(2), v);
    else e.setAttribute(k,v);
  }
  for(const c of children){
    if(typeof c==='string') e.appendChild(document.createTextNode(c));
    else if(c) e.appendChild(c);
  }
  return e;
}

// Login
function renderLogin(){
  app.innerHTML='';
  const bg = el('div',{class:'login-bg'});
  const box = el('div',{class:'login-box'},
    el('h2',{},'TopView System'),
    el('input',{id:'email', type:'email', placeholder:'Email'}),
    el('input',{id:'password', type:'password', placeholder:'Password'}),
    el('button',{onclick:login},'Login')
  );
  app.append(bg,box);
}

function login(){
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value.trim();
  if(email==='admin@topview.com' && password==='123456'){
    state.user={name:'Admin'};
    loadAll();
    renderDashboard();
  } else alert('Invalid credentials');
}

// Load all data
function loadAll(){
  db.collection('clients').onSnapshot(s=>{
    state.clients = s.docs.map(d=>({id:d.id, ...d.data()}));
    if(state.user) renderDashboard();
  });
  db.collection('attendance').onSnapshot(s=>{
    state.attendance = s.docs.map(d=>({id:d.id, ...d.data()}));
    if(state.user) renderDashboard();
  });
  db.collection('costs').onSnapshot(s=>{
    state.costs = s.docs.map(d=>({id:d.id, ...d.data()}));
    if(state.user) renderDashboard();
  });
}

// Dashboard
function renderDashboard(){
  app.innerHTML='';
  const sidebar = el('div',{class:'sidebar'},
    el('h3',{},'TopView'),
    el('button',{class: state.page==='clients'?'active':'', onclick:()=>switchPage('clients')},'Clients'),
    el('button',{class: state.page==='attendance'?'active':'', onclick:()=>switchPage('attendance')},'Attendance'),
    el('button',{class: state.page==='costs'?'active':'', onclick:()=>switchPage('costs')},'Costs'),
    el('button',{onclick:logout},'Logout')
  );
  const main = el('main');
  if(state.page==='clients') main.appendChild(buildClientsTable());
  if(state.page==='attendance') main.appendChild(buildAttendanceTable());
  if(state.page==='costs') main.appendChild(buildCostsTable());
  app.append(sidebar, main);
}

function switchPage(p){ state.page=p; renderDashboard(); }
function logout(){ state.user=null; renderLogin(); }

// Editable cell helper
function editableCell(obj, field, coll){
  const d = el('div',{contenteditable:true, style:'min-width:100px;'}, obj[field]||'');
  d.addEventListener('blur', async ()=>{
    const val = d.textContent.trim();
    await db.collection(coll).doc(obj.id).update({[field]:val});
  });
  d.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); d.blur(); } });
  return d;
}

// Delete button helper
function deleteBtn(id, coll){
  const b = el('button',{class:'btn ghost'},'Delete');
  b.onclick = async ()=>{
    if(confirm('Delete this row?')) await db.collection(coll).doc(id).delete();
  }
  return b;
}

// Clients table
function buildClientsTable(){
  const wrap = el('div',{class:'card'});
  wrap.appendChild(el('div',{style:'display:flex;justify-content:space-between;align-items:center;margin-bottom:8px'},
    el('h3',{},'Clients'),
    el('button',{class:'btn', onclick:openAddClient},'Add Client')
  ));
  const table = el('table');
  const thead = el('thead',{}, el('tr',{},
    el('th',{},'Client No'),
    el('th',{},'Name'),
    el('th',{},'Nationality'),
    el('th',{},'ID Number'),
    el('th',{},'Email'),
    el('th',{},'Location'),
    el('th',{},'Building Name'),
    el('th',{},'Unit Type'),
    el('th',{},'Property No'),
    el('th',{},'Comments'),
    el('th',{},'Delete')
  ));
  const tbody = el('tbody');
  state.clients.forEach(c=>{
    const tr = el('tr',{},
      el('td',{},editableCell(c,'clientNo','clients')),
      el('td',{},editableCell(c,'name','clients')),
      el('td',{},editableCell(c,'nationality','clients')),
      el('td',{},editableCell(c,'idNumber','clients')),
      el('td',{},editableCell(c,'email','clients')),
      el('td',{},editableCell(c,'location','clients')),
      el('td',{},editableCell(c,'building','clients')),
      el('td',{},editableCell(c,'unitType','clients')),
      el('td',{},editableCell(c,'propertyNo','clients')),
      el('td',{},editableCell(c,'comments','clients')),
      el('td',{},deleteBtn(c.id,'clients'))
    );
    tbody.appendChild(tr);
  });
  table.appendChild(thead);
  table.appendChild(tbody);
  wrap.appendChild(table);
  return wrap;
}

async function openAddClient(){
  const clientNo = prompt('Client No:'); if(!clientNo) return;
  const name = prompt('Name:'); if(!name) return;
  const nationality = prompt('Nationality:'); 
  const idNumber = prompt('ID Number:'); 
  const email = prompt('Email:'); 
  const location = prompt('Location:'); 
  const building = prompt('Building Name:'); 
  const unitType = prompt('Unit Type:'); 
  const propertyNo = prompt('Property No:'); 
  const comments = prompt('Comments:'); 
  await db.collection('clients').add({clientNo, name, nationality, idNumber, email, location, building, unitType, propertyNo, comments, createdAt:new Date().toISOString()});
  alert('Client added!');
}

// Attendance table
function buildAttendanceTable(){
  const wrap = el('div',{class:'card'});
  wrap.appendChild(el('div',{style:'display:flex;justify-content:space-between;align-items:center;margin-bottom:8px'},
    el('h3',{},'Attendance'),
    el('button',{class:'btn', onclick:openAddAttendance},'Add Attendance')
  ));
  const table = el('table');
  const thead = el('thead',{}, el('tr',{},
    el('th',{},'Date'),
    el('th',{},'Full Name'),
    el('th',{},'Job Title'),
    el('th',{},'Department'),
    el('th',{},'Check In'),
    el('th',{},'Check Out'),
    el('th',{},'Hours'),
    el('th',{},'Extra Hours'),
    el('th',{},'Late Hours'),
    el('th',{},'Admin Notes'),
    el('th',{},'Comments'),
    el('th',{},'Delete')
  ));
  const tbody = el('tbody');
  state.attendance.forEach(a=>{
    const tr = el('tr',{},
      el('td',{},editableCell(a,'date','attendance')),
      el('td',{},editableCell(a,'fullName','attendance')),
      el('td',{},editableCell(a,'jobTitle','attendance')),
      el('td',{},editableCell(a,'department','attendance')),
      el('td',{},editableCell(a,'checkIn','attendance')),
      el('td',{},editableCell(a,'checkOut','attendance')),
      el('td',{},editableCell(a,'hours','attendance')),
      el('td',{},editableCell(a,'extraHours','attendance')),
      el('td',{},editableCell(a,'lateHours','attendance')),
      el('td',{},editableCell(a,'adminNotes','attendance')),
      el('td',{},editableCell(a,'comments','attendance')),
      el('td',{},deleteBtn(a.id,'attendance'))
    );
    tbody.appendChild(tr);
  });
  table.appendChild(thead);
  table.appendChild(tbody);
  wrap.appendChild(table);
  return wrap;
}

async function openAddAttendance(){
  const date = prompt('Date:'); if(!date) return;
  const fullName = prompt('Full Name:'); if(!fullName) return;
  const jobTitle = prompt('Job Title:'); 
  const department = prompt('Department:'); 
  const checkIn = prompt('Check In:'); 
  const checkOut = prompt('Check Out:'); 
  const hours = prompt('Hours:'); 
  const extraHours = prompt('Extra Hours:'); 
  const lateHours = prompt('Late Hours:'); 
  const adminNotes = prompt('Admin Notes:'); 
  const comments = prompt('Comments:'); 
  await db.collection('attendance').add({date, fullName, jobTitle, department, checkIn, checkOut, hours, extraHours, lateHours, adminNotes, comments, createdAt:new Date().toISOString()});
  alert('Attendance added!');
}

// Costs table
function buildCostsTable(){
  const wrap = el('div',{class:'card'});
  wrap.appendChild(el('div',{style:'display:flex;justify-content:space-between;align-items:center;margin-bottom:8px'},
    el('h3',{},'Costs'),
    el('button',{class:'btn', onclick:openAddCost},'Add Cost')
  ));
  const table = el('table');
  const thead = el('thead',{}, el('tr',{},
    el('th',{},'Main Section'),
    el('th',{},'Sub Item'),
    el('th',{},'Description'),
    el('th',{},'Quantity'),
    el('th',{},'Unit Price'),
    el('th',{},'Total'),
    el('th',{},'Payment Method'),
    el('th',{},'Invoice No'),
    el('th',{},'Purchase Date'),
    el('th',{},'Comments'),
    el('th',{},'Delete')
  ));
  const tbody = el('tbody');
  state.costs.forEach(c=>{
    const tr = el('tr',{},
      el('td',{},editableCell(c,'mainSection','costs')),
      el('td',{},editableCell(c,'subItem','costs')),
      el('td',{},editableCell(c,'description','costs')),
      el('td',{},editableCell(c,'quantity','costs')),
      el('td',{},editableCell(c,'unitPrice','costs')),
      el('td',{},editableCell(c,'total','costs')),
      el('td',{},editableCell(c,'paymentMethod','costs')),
      el('td',{},editableCell(c,'invoiceNo','costs')),
      el('td',{},editableCell(c,'purchaseDate','costs')),
      el('td',{},editableCell(c,'comments','costs')),
      el('td',{},deleteBtn(c.id,'costs'))
    );
    tbody.appendChild(tr);
  });
  table.appendChild(thead);
  table.appendChild(tbody);
  wrap.appendChild(table);
  return wrap;
}

async function openAddCost(){
  const mainSection = prompt('Main Section:'); if(!mainSection) return;
  const subItem = prompt('Sub Item:'); 
  const description = prompt('Description:'); 
  const quantity = prompt('Quantity:'); 
  const unitPrice = prompt('Unit Price:'); 
  const total = prompt('Total:'); 
  const paymentMethod = prompt('Payment Method:'); 
  const invoiceNo = prompt('Invoice No:'); 
  const purchaseDate = prompt('Purchase Date:'); 
  const comments = prompt('Comments:'); 
  await db.collection('costs').add({mainSection, subItem, description, quantity, unitPrice, total, paymentMethod, invoiceNo, purchaseDate, comments, createdAt:new Date().toISOString()});
  alert('Cost added!');
}

// Initial render
renderLogin();
</script>
</body>
</html>
