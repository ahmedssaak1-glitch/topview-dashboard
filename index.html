<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TOP VIEW — Management System</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --accent:#1f78ff;
      --muted:#6b7280;
      --bg:#f6f7fb;
      --card:#ffffff;
      --glass: rgba(255,255,255,0.95);
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Arial; margin:0; background:var(--bg); color:#0f172a; direction: rtl}
    a{color:inherit}
    header{padding:14px 20px; background:#ffffff; border-bottom:1px solid #eef2f7; display:flex; align-items:center; gap:12px}
    .brand{font-weight:800; color:var(--accent); font-size:18px}
    .container{padding:18px}
    /* layout */
    .app{display:flex; min-height:calc(100vh - 56px)}
    .sidebar{width:260px; background:linear-gradient(180deg,#fff,#fbfcff); border-left:1px solid #eef2f7; padding:18px; display:flex; flex-direction:column; gap:12px}
    .nav button{display:block;padding:10px;border-radius:8px;border:0;background:transparent;text-align:right;width:100%;cursor:pointer;font-weight:600}
    .nav button.active{background:#f1f6ff;color:var(--accent)}
    .main{flex:1;padding:20px}
    .card{background:var(--card); padding:16px; border-radius:12px; box-shadow:0 6px 20px rgba(2,6,23,0.04)}
    .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:14px}
    .stat{padding:12px;border-radius:10px;background:var(--card); box-shadow:0 6px 20px rgba(2,6,23,0.04)}
    table{width:100%; border-collapse:collapse; font-size:14px; margin-top:10px}
    th,td{padding:10px 12px; border-bottom:1px solid #f3f6fa; text-align:right}
    th{background:#fafbff; color:var(--muted); font-weight:700}
    input, select, textarea{width:100%; padding:10px;border-radius:8px;border:1px solid #e6e9ef; margin:6px 0}
    .row{display:flex; gap:10px}
    .row .col{flex:1}
    .btn{padding:10px 12px;border-radius:8px;border:0;background:var(--accent); color:#fff; cursor:pointer}
    .btn.ghost{background:transparent;color:var(--muted);border:1px solid rgba(15,23,42,0.06)}
    .small{font-size:13px;color:var(--muted)}
    .login-wrap{min-height:calc(100vh - 56px); display:flex; align-items:center; justify-content:center}
    .login-card{width:100%; max-width:420px; padding:28px; border-radius:12px; background:var(--glass); box-shadow:0 10px 30px rgba(2,6,23,0.08)}
    @media(max-width:900px){ .sidebar{display:none} .grid{grid-template-columns:repeat(2,1fr)} }
    @media(max-width:600px){ .grid{grid-template-columns:1fr} .login-card{padding:20px} table, th, td {font-size:13px} }
    /* safety overlays */
    .overlay, .backdrop, .modal-backdrop, [data-overlay] { pointer-events: none !important; z-index: 1 !important; }
    input, textarea, select { color:#0b1220 !important; background:#fff !important; caret-color:#0b1220 !important; }
  </style>
</head>
<body>
  <header>
    <div class="brand">TOP VIEW</div>
    <div class="small">نظام إدارة الشركة — الديكور الداخلي</div>
    <div style="margin-left:auto" id="user-info"></div>
  </header>

  <div id="root" class="container"></div>

  <script type="module">
  /* ============================
     TOP VIEW — Single-file SPA
     Firebase modular (CDN)
     Features:
     - Auth (email/password)
     - Firestore: users(employees), projects, transactions, attendance
     - CRUD UI for each section
     - Seed demo data
     ============================ */

  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    getDocs,
    addDoc,
    setDoc,
    doc,
    deleteDoc,
    updateDoc,
    getDoc,
    query,
    where,
    orderBy,
    limit
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
  import { getStorage } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

  // -------------------------
  // Paste your Firebase config below (or keep as-is if this is your project).
  // The config used here is the one you shared earlier.
  // -------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyCEpRw7F829fqzPZAphqJ2wOe3xUDJWLtw",
    authDomain: "topview-system.firebaseapp.com",
    projectId: "topview-system",
    storageBucket: "topview-system.firebasestorage.app",
    messagingSenderId: "1073945877413",
    appId: "1:1073945877413:web:d516e451e543f7a9db664c",
    measurementId: "G-EPVZGH6Y2G"
  };

  const fbApp = initializeApp(firebaseConfig);
  try { getAnalytics(fbApp); } catch(e){ /* optional */ }
  const auth = getAuth(fbApp);
  const db = getFirestore(fbApp);
  const storage = getStorage(fbApp);

  // DOM helpers
  const root = document.getElementById('root');
  const userInfo = document.getElementById('user-info');
  function el(tag, attrs={}, ...kids){
    const n = document.createElement(tag);
    for(const k in attrs){
      if(k === 'class') n.className = attrs[k];
      else if(k === 'html') n.innerHTML = attrs[k];
      else n.setAttribute(k, attrs[k]);
    }
    kids.forEach(c => { if(typeof c === 'string') n.appendChild(document.createTextNode(c)); else if(c) n.appendChild(c); });
    return n;
  }

  // Small utility to format number
  function money(v){ return 'AED ' + (Number(v)||0); }
  function nowDate(){ return new Date().toISOString().slice(0,10); }

  // ---------- Authentication UI & logic ----------
  async function seedDemoData(){
    // create demo users and sample data
    // only run if collections empty (best-effort)
    try{
      const usersCol = collection(db,'users');
      const usersSnap = await getDocs(usersCol);
      if(!usersSnap.empty) return alert('Demo data already exists');

      const demo = [
        {username:'m.fouad', name:'Mohamed Fouad', role:'Manager', salary:15000, email:'m.fouad@topview.local'},
        {username:'m.salah', name:'Mohamed Salah', role:'Supervisor', salary:8000, email:'m.salah@topview.local'},
        {username:'ibrahim', name:'Ibrahim', role:'Worker', salary:3500, email:'ibrahim@topview.local'}
      ];
      for(const u of demo){
        // create Firestore doc
        const docRef = await addDoc(usersCol, {...u});
        // create Auth user with default password (ignore if exists)
        try{
          const cu = await createUserWithEmailAndPassword(auth, u.email, 'pass123');
          // map auth uid -> user doc (set field uid)
          await setDoc(doc(db,'users', docRef.id), {...u, uid: cu.user.uid}, { merge: true });
        }catch(e){ console.warn('auth create user error', e.message); }
      }
      await addDoc(collection(db,'projects'), {name:'Apartment 12B Fitout', client:'Mr. Hassan', status:'In Progress', budget:45000, engineer:'Mohamed Salah'});
      await addDoc(collection(db,'transactions'), {type:'Expense', category:'Materials', amount:12000, date:nowDate(), note:'Tiles+adhesives'});
      alert('Demo data created. Emails like m.fouad@topview.local, password: pass123');
    }catch(e){
      console.error(e); alert('Error seeding demo data: ' + e.message);
    }
  }

  function showLogin(){
    root.innerHTML = '';
    const wrap = el('div',{class:'login-wrap'});
    const card = el('div',{class:'login-card'});
    card.appendChild(el('div',{class:'logo'}, 'TOP VIEW'));
    card.appendChild(el('div',{class:'small'}, 'نظام إدارة المشاريع والمدفوعات والموظفين'));
    card.appendChild(el('hr'));
    const email = el('input',{type:'email', placeholder:'البريد الالكتروني'});
    const pass = el('input',{type:'password', placeholder:'كلمة المرور'});
    const row = el('div',{style:'display:flex;gap:8px;flex-direction:row-reverse;'});
    const btnLogin = el('button',{class:'btn'}, 'دخول');
    btnLogin.onclick = async () => {
      try{
        await signInWithEmailAndPassword(auth, email.value.trim(), pass.value);
      }catch(e){
        alert('فشل تسجيل الدخول: ' + (e.message || e));
      }
    };
    const btnSeed = el('button',{class:'btn ghost'}, 'إنشاء بيانات تجريبية');
    btnSeed.onclick = seedDemoData;
    row.appendChild(btnLogin); row.appendChild(btnSeed);
    card.appendChild(email); card.appendChild(pass); card.appendChild(row);
    card.appendChild(el('p',{class:'small'}, 'أو قم بالتسجيل ثم سيُنشأ مستند المستخدم تلقائياً'));
    const btnSignup = el('button',{class:'btn', style:'margin-top:8px'}, 'تسجيل حساب جديد');
    btnSignup.onclick = async () => {
      const name = prompt('الاسم الكامل (مثلاً: Ahmed Ali)');
      if(!name) return;
      const emailv = prompt('البريد الالكتروني (للدخول)');
      if(!emailv) return;
      const password = prompt('كلمة المرور (سيتم استخدامها لتسجيل الدخول)');
      if(!password) return;
      try{
        const { user } = await createUserWithEmailAndPassword(auth, emailv.trim(), password);
        // create user doc and map uid
        await addDoc(collection(db,'users'), { name, email: emailv.trim(), role: 'Worker', salary: 3000, uid: user.uid, username: emailv.split('@')[0] });
        alert('تم إنشاء الحساب. سجّل دخول الآن.');
      }catch(e){ alert('خطأ عند التسجيل: ' + (e.message || e)); }
    };
    card.appendChild(btnSignup);
    wrap.appendChild(card);
    root.appendChild(wrap);
  }

  // ---------- Main App ----------
  function appLayout(currentUserDoc){
    root.innerHTML = '';
    // sidebar and main
    const app = el('div',{class:'app'});
    const sidebar = el('div',{class:'sidebar'});
    sidebar.appendChild(el('div',{class:'small'}, 'TOP VIEW — الإدارة'));
    const nav = el('div',{class:'nav'});
    const pages = ['لوحة التحكم','الموظفون','المشاريع','المالية','الحضور','الإعدادات'];
    let active = 'لوحة التحكم';

    pages.forEach(p=>{
      const b = el('button',{}, p);
      b.onclick = ()=>{ active = p; renderMain(); };
      nav.appendChild(b);
    });
    sidebar.appendChild(nav);

    const userBox = el('div',{class:'card'});
    userBox.appendChild(el('div',{style:'font-weight:700'}, currentUserDoc.name || currentUserDoc.email));
    userBox.appendChild(el('div',{class:'small'}, currentUserDoc.role || '—'));
    const logout = el('button',{class:'btn ghost', style:'margin-top:8px'}, 'خروج');
    logout.onclick = ()=> signOut(auth);
    userBox.appendChild(logout);
    sidebar.appendChild(userBox);

    const main = el('div',{class:'main'});
    app.appendChild(sidebar); app.appendChild(main);
    root.appendChild(app);

    // Fetch data helpers
    async function fetchAll(){
      const [uSnap, pSnap, tSnap, aSnap] = await Promise.all([
        getDocs(collection(db,'users')),
        getDocs(collection(db,'projects')),
        getDocs(collection(db,'transactions')),
        getDocs(collection(db,'attendance'))
      ]);
      const users = uSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      const projects = pSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      const transactions = tSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      const attendance = aSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      return { users, projects, transactions, attendance };
    }

    // Render helpers: tables & forms
    function renderProjectsTable(projects){
      const wrap = el('div',{class:'card'});
      const table = el('table');
      table.appendChild(el('thead',{}, el('tr',{}, el('th',{},'الاسم'), el('th',{},'العميل'), el('th',{},'الحالة'), el('th',{},'الميزانية'))));
      const tb = el('tbody');
      projects.forEach(p=>{
        const tr = el('tr');
        tr.appendChild(el('td',{},p.name));
        tr.appendChild(el('td',{},p.client||'-'));
        tr.appendChild(el('td',{},p.status||'-'));
        tr.appendChild(el('td',{}, money(p.budget)));
        tb.appendChild(tr);
      });
      table.appendChild(tb); wrap.appendChild(table);
      return wrap;
    }

    function renderEmployeesTable(users){
      const wrap = el('div',{class:'card'});
      const table = el('table');
      table.appendChild(el('thead',{}, el('tr',{}, el('th',{},'الاسم'), el('th',{},'الدور'), el('th',{},'الراتب'), el('th',{},'البريد'), el('th',{},'إجراءات'))));
      const tb = el('tbody');
      users.forEach(u=>{
        const tr = el('tr');
        tr.appendChild(el('td',{},u.name));
        tr.appendChild(el('td',{},u.role||'-'));
        tr.appendChild(el('td',{}, money(u.salary)));
        tr.appendChild(el('td',{},u.email||'-'));
        const actionTd = el('td',{});
        const del = el('button',{class:'btn ghost'}, 'حذف');
        del.onclick = async ()=>{
          if(!confirm('حذف الموظف؟')) return;
          try{
            if(u.uid){
              // try to delete user auth — requires admin privileges (not possible from client SDK)
              // So only delete Firestore doc here
            }
            await deleteDoc(doc(db,'users',u.id));
            alert('تم الحذف'); renderMain();
          }catch(e){ alert('خطأ: ' + e.message); }
        };
        actionTd.appendChild(del);
        tr.appendChild(actionTd);
        tb.appendChild(tr);
      });
      table.appendChild(tb); wrap.appendChild(table);
      return wrap;
    }

    function renderTransactionsTable(transactions){
      const wrap = el('div',{class:'card'});
      const table = el('table');
      table.appendChild(el('thead',{}, el('tr',{}, el('th',{},'النوع'), el('th',{},'الفئة'), el('th',{},'المبلغ'), el('th',{},'التاريخ'))));
      const tb = el('tbody');
      transactions.forEach(t=>{
        const tr = el('tr');
        tr.appendChild(el('td',{},t.type));
        tr.appendChild(el('td',{},t.category));
        tr.appendChild(el('td',{}, money(t.amount)));
        tr.appendChild(el('td',{}, t.date));
        tb.appendChild(tr);
      });
      table.appendChild(tb); wrap.appendChild(table);
      return wrap;
    }

    function renderAttendanceTable(attendance, users){
      const wrap = el('div',{class:'card'});
      const table = el('table');
      table.appendChild(el('thead',{}, el('tr',{}, el('th',{},'الموظف'), el('th',{},'التاريخ'), el('th',{},'دخول'), el('th',{},'خروج'))));
      const tb = el('tbody');
      attendance.slice().reverse().forEach(a=>{
        const u = users.find(x=> x.uid === a.uid) || users.find(x=> x.id === a.userId) || { name: a.name || '—' };
        const tr = el('tr');
        tr.appendChild(el('td',{}, u.name || '—'));
        tr.appendChild(el('td',{}, a.date));
        tr.appendChild(el('td',{}, a.in||'-'));
        tr.appendChild(el('td',{}, a.out||'-'));
        tb.appendChild(tr);
      });
      table.appendChild(tb); wrap.appendChild(table);
      return wrap;
    }

    // CRUD forms (prompts used for simplicity)
    async function addEmployee(){
      const name = prompt('الاسم الكامل'); if(!name) return;
      const email = prompt('البريد الالكتروني (مستخدم لتسجيل الدخول)'); if(!email) return;
      const role = prompt('الدور','Worker');
      const salary = Number(prompt('الراتب AED','3000')||3000);
      try{
        // Create Auth user and store uid in users collection
        const { user } = await createUserWithEmailAndPassword(auth, email.trim(), 'pass123');
        await addDoc(collection(db,'users'), { name, email: email.trim(), role, salary, uid: user.uid, username: email.split('@')[0] });
        alert('تم إضافة الموظف. كلمة مرور افتراضية: pass123');
        renderMain();
      }catch(e){
        alert('خطأ: ' + (e.message || e));
      }
    }
    async function addProject(){
      const name = prompt('اسم المشروع'); if(!name) return;
      const client = prompt('اسم العميل'); const budget = Number(prompt('الميزانية AED','10000')||10000);
      await addDoc(collection(db,'projects'), { name, client, budget, status:'Planned', engineer:'' });
      alert('تم إضافة المشروع'); renderMain();
    }
    async function addTransaction(){
      const type = prompt('النوع: Expense أو Income','Expense'); if(!type) return;
      const cat = prompt('الفئة','Materials'); const amount = Number(prompt('المبلغ AED','1000')||1000);
      const note = prompt('ملاحظة (اختياري)');
      await addDoc(collection(db,'transactions'), { type, category:cat, amount, date: nowDate(), note: note || '' });
      alert('تمت الإضافة'); renderMain();
    }

    async function recordIn(){
      const user = auth.currentUser;
      if(!user) return alert('غير مسجل الدخول');
      await addDoc(collection(db,'attendance'), { uid: user.uid, date: nowDate(), in: new Date().toLocaleTimeString(), out: '' });
      alert('تم تسجيل الدخول'); renderMain();
    }
    async function recordOut(){
      const user = auth.currentUser;
      if(!user) return alert('غير مسجل الدخول');
      const q = query(collection(db,'attendance'), where('uid','==', user.uid), where('date','==', nowDate()), where('out','==',''));
      const snap = await getDocs(q);
      if(snap.empty) return alert('لا يوجد تسجيل دخول مفتوح لليوم');
      const last = snap.docs[snap.docs.length - 1];
      await updateDoc(doc(db,'attendance', last.id), { out: new Date().toLocaleTimeString() });
      alert('تم تسجيل الخروج'); renderMain();
    }

    // Main render
    async function renderMain(){
      main.innerHTML = '';
      const data = await fetchAll();
      // topbar stats
      const inc = data.transactions.filter(t=>t.type==='Income').reduce((s,t)=>s+(t.amount||0),0);
      const exp = data.transactions.filter(t=>t.type==='Expense').reduce((s,t)=>s+(t.amount||0),0);
      const profit = inc - exp;
      if(active === 'لوحة التحكم'){
        const stats = el('div',{class:'grid'});
        stats.appendChild(el('div',{class:'stat'}, el('div',{class:'small'}, 'الإيرادات'), el('div',{style:'font-weight:700;font-size:18px'}, money(inc))));
        stats.appendChild(el('div',{class:'stat'}, el('div',{class:'small'}, 'المصروفات'), el('div',{style:'font-weight:700;font-size:18px'}, money(exp))));
        stats.appendChild(el('div',{class:'stat'}, el('div',{class:'small'}, 'الربح'), el('div',{style:'font-weight:700;font-size:18px'}, money(profit))));
        main.appendChild(stats);
        main.appendChild(el('h3',{}, 'المشاريع النشطة'));
        main.appendChild(renderProjectsTable(data.projects));
      }
      if(active === 'الموظفون'){
        main.appendChild(el('h3',{}, 'الموظفون'));
        main.appendChild(renderEmployeesTable(data.users));
        main.appendChild(el('div',{style:'margin-top:12px'}, el('button',{class:'btn', onclick: addEmployee}, 'إضافة موظف')));
      }
      if(active === 'المشاريع'){
        main.appendChild(el('h3',{}, 'المشاريع'));
        main.appendChild(renderProjectsTable(data.projects));
        main.appendChild(el('div',{style:'margin-top:12px'}, el('button',{class:'btn', onclick: addProject}, 'مشروع جديد')));
      }
      if(active === 'المالية'){
        main.appendChild(el('h3',{}, 'المالية'));
        main.appendChild(renderTransactionsTable(data.transactions));
        main.appendChild(el('div',{style:'margin-top:12px'}, el('button',{class:'btn', onclick: addTransaction}, 'إضافة معاملة')));
      }
      if(active === 'الحضور'){
        main.appendChild(el('h3',{}, 'الحضور'));
        main.appendChild(el('div',{style:'display:flex;gap:8px;flex-direction:row-reverse'}, el('button',{class:'btn', onclick: recordIn}, 'تسجيل حضور (دخول)'), el('button',{class:'btn ghost', onclick: recordOut}, 'تسجيل خروج (خروج)')));
        main.appendChild(renderAttendanceTable(data.attendance, data.users));
      }
      if(active === 'الإعدادات'){
        main.appendChild(el('h3',{}, 'الإعدادات'));
        main.appendChild(el('div',{class:'card'}, el('p',{}, 'شركة: TOP VIEW — إدارة الديكور الداخلي')));
        main.appendChild(el('div',{style:'margin-top:8px'}, el('button',{class:'btn ghost', onclick: seedDemoData}, 'إعادة إنشاء بيانات تجريبية (إن لم توجد)')));
      }
      updateNav();
    }

    renderMain();
    } // end appLayout

  // ---------- Auth state monitoring ----------
  let currentUserDoc = null;
  onAuthStateChanged(auth, async (user) => {
    if(!user){
      userInfo.innerHTML = '';
      showLogin();
      return;
    }
    // load user document by uid
    try{
      // try to find user doc with uid
      const usersSnap = await getDocs(query(collection(db,'users'), where('uid','==', user.uid), limit(1)));
      if(!usersSnap.empty){
        currentUserDoc = { id: usersSnap.docs[0].id, ...usersSnap.docs[0].data() };
      }else{
        // fallback: create user doc from auth profile
        const docRef = await addDoc(collection(db,'users'), { name: user.displayName || user.email.split('@')[0], email: user.email, uid: user.uid, role: 'Worker', salary: 3000 });
        currentUserDoc = { id: docRef.id, name: user.displayName || user.email.split('@')[0], email: user.email, uid: user.uid, role: 'Worker', salary: 3000 };
      }
      // update header
      userInfo.innerHTML = `<span class="small">مرحباً، ${currentUserDoc.name || user.email}</span>`;
      appLayout(currentUserDoc);
    }catch(e){
      console.error(e);
      alert('خطأ عند تحميل بيانات المستخدم: ' + e.message);
      signOut(auth);
    }
  });

  // end of module
  </script>
</body>
</html>
