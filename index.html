<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Top View — Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
body {
  font-family: 'Inter', sans-serif;
  margin: 0;
  background: url('https://images.unsplash.com/photo-1526481280695-3c720685208b?auto=format&fit=crop&w=1500&q=80') center/cover no-repeat;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}
#overlay {
  position: absolute;
  inset: 0;
  background-color: rgba(0, 0, 0, 0.5);
}
#login, #dashboard {
  position: relative;
  z-index: 2;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  border-radius: 20px;
  padding: 30px;
  text-align: center;
  color: #fff;
  width: 90%;
  max-width: 1000px;
}
input {
  display: block;
  width: 100%;
  padding: 10px;
  margin: 10px 0;
  border-radius: 8px;
  border: none;
}
button {
  background: #ffcc00;
  color: #000;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  background: rgba(255,255,255,0.8);
  color:#000;
}
th, td {
  padding: 8px;
  border: 1px solid #ddd;
}
td div[contenteditable] {
  min-width: 100px;
  outline: none;
}
.file-uploader {
  display:inline-block;
  padding:6px 8px;
  border-radius:8px;
  border:1px dashed #ccc;
  cursor:pointer;
}
</style>
</head>
<body>
<div id="overlay"></div>

<!-- Login -->
<div id="login">
  <h2>Top View Login</h2>
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Password" />
  <button onclick="login()">Login</button>
</div>

<!-- Dashboard -->
<div id="dashboard" style="display:none;">
  <h2>Dashboard</h2>
  <button onclick="logout()">Logout</button>

  <div id="tablesContainer"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, addDoc, setDoc, doc, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCEpRw7F829fqzPZAphqJ2wOe3xUDJWLtw",
  authDomain: "topview-system.firebaseapp.com",
  projectId: "topview-system",
  storageBucket: "topview-system.appspot.com",
  messagingSenderId: "1073945877413",
  appId: "1:1073945877413:web:d516e451e543f7a9db664c"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// ===== Columns for each table =====
const pagesColumns = {
  generalAccounts:["رقم العميل","اسم العميل","الجنسيه","رقم الهويه","البريد الالكتروني","الموقع","اسم المبنى","نوع الوحدة","رقم العقار","ملاحظات"],
  attendanceLog:["التاريخ","الاسم الكامل","المسمى الوظيفي","القسم","وقت الحضور","وقت الانصراف","عدد ساعات العمل","ساعات إضافية","ساعات تأخير","ملاحظات المشرف","ملاحظات"],
  employeeRecords:["الاسم الكامل","المسمى الوظيفي","الجنسية","رقم الإقامة","تاريخ انتهاء الإقامة","رقم الجواز","الهاتف","تاريخ التعيين","نوع العقد","الراتب الاساسى","سكن","البنك","رقم الحساب","حالة الإقامة","ملاحظات"],
  salariesBonuses:["الاسم الكامل","المسمى الوظيفي","القسم","الجنسية","تاريخ التعيين","الراتب الاساسى","الحوافز","المكافآت","نسبة الحضور والانضباط","اجمالى المستحق","السلف","الخصومات","الجزاءات","صافى الراتب بعد الخصم","طريقة الدفع","البنك","رقم الحساب","تاريخ الصرف","ملاحظات"],
  costRecords:["التاريخ","البند","نوع المصروف","المبلغ","ملاحظات"]
};

// ===== Login =====
async function login(){
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try {
    await signInWithEmailAndPassword(auth,email,password);
    document.getElementById("login").style.display="none";
    document.getElementById("dashboard").style.display="block";
    renderAllTables();
  } catch(err){
    alert("خطأ في تسجيل الدخول: "+err.message);
  }
}

// Logout
function logout(){
  signOut(auth).then(()=>{
    document.getElementById("dashboard").style.display="none";
    document.getElementById("login").style.display="block";
  });
}

// ===== Render Tables =====
function renderAllTables(){
  const container = document.getElementById("tablesContainer");
  container.innerHTML="";
  for(const page in pagesColumns){
    const card = document.createElement('div');
    card.style.marginBottom="30px";
    card.innerHTML = `
      <h3>${page}</h3>
      <button onclick="addRow('${page}')">Add Row</button>
      <table id="${page}Table">
        <thead>
          <tr>
            ${pagesColumns[page].map(c=>`<th>${c}</th>`).join('')}
            <th>Attachments</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    `;
    container.appendChild(card);
    loadTableData(page);
  }
}

// ===== Load Table Data =====
async function loadTableData(page){
  const tbody = document.querySelector(`#${page}Table tbody`);
  tbody.innerHTML="";
  const snapshot = await getDocs(collection(db,page));
  snapshot.forEach(docSnap=>{
    addRowToTable(page,docSnap.data(),docSnap.id);
  });
}

// ===== Add Row =====
function addRow(page,data={},id=null){
  const tbody = document.querySelector(`#${page}Table tbody`);
  const tr = document.createElement('tr');
  tr.innerHTML = pagesColumns[page].map(col=>`<td><div contenteditable>${data[col]||''}</div></td>`).join('')+
    `<td><label class="file-uploader">Attach<input type="file" style="display:none" onchange="uploadFile(event,'${page}','${id||''}',this)"></label></td>`+
    `<td><button onclick="saveRow('${page}',this,'${id||''}')">Save</button></td>`;
  tbody.appendChild(tr);
}

// ===== Add Row To Table =====
function addRowToTable(page,data,id){
  addRow(page,data,id);
}

// ===== Save Row =====
async function saveRow(page,btn,id){
  const tr = btn.closest('tr');
  const data = {};
  pagesColumns[page].forEach((col,i)=>{
    data[col] = tr.children[i].innerText;
  });
  try{
    if(id){
      await setDoc(doc(db,page,id),data);
    } else {
      const docRef = await addDoc(collection(db,page),data);
      btn.setAttribute("onclick",`saveRow('${page}',this,'${docRef.id}')`);
    }
    alert("Saved!");
  }catch(err){
    alert("Error: "+err.message);
  }
}

// ===== Upload File =====
async function uploadFile(e,page,id,input){
  const file = e.target.files[0];
  if(!file) return;
  const filename = `${page}/${Date.now()}_${file.name}`;
  const fileRef = ref(storage, filename);
  try{
    await uploadBytes(fileRef,file);
    const url = await getDownloadURL(fileRef);
    alert("File uploaded!");
    console.log("File URL:",url);
  }catch(err){
    alert("Upload error: "+err.message);
  }
}

window.login = login;
window.addRow = addRow;
window.saveRow = saveRow;
window.uploadFile = uploadFile;
window.logout = logout;
</script>

</body>
</html>
