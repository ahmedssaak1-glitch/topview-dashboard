<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TOP VIEW — Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --accent:#d4af37; /* دهبي */
      --blue:#007bff;
      --bg:#f4f6fa;
      --card:#ffffff;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Arial; margin:0; background:var(--bg); color:#0b1220; direction:rtl}
    header{height:64px; display:flex; align-items:center; gap:12px; padding:0 18px; background:var(--card); border-bottom:1px solid #e9eef6}
    .brand{font-weight:800;color:var(--blue); font-size:18px}
    .layout{display:flex; min-height:calc(100vh - 64px)}
    .sidebar{width:260px; background:#fff; border-left:1px solid #eef2f7; padding:18px; display:flex; flex-direction:column; gap:10px}
    .sidebar h4{margin:0;text-align:center;color:var(--blue)}
    .side-btn{background:transparent;border:0;text-align:right;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    .side-btn.active{background:#f1f6ff;color:var(--blue)}
    main{flex:1;padding:18px}
    .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.04)}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .search{padding:8px 10px;border-radius:8px;border:1px solid #e6e9ef; width:320px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-bottom:1px solid #f3f6fa;text-align:right;vertical-align:middle}
    th{background:#fafbff;color:#6b7280;font-weight:700}
    td div[contenteditable]{min-width:80px;outline:none;padding:6px;border-radius:6px}
    tr:hover td{background:#fbfcff}
    .thumbnail{width:44px;height:32px;object-fit:cover;border-radius:6px;border:1px solid #eef4ff;cursor:pointer}
    .file-uploader{font-size:13px;padding:6px;border-radius:6px;border:1px dashed #e3e8f1;background:#fbfdff;cursor:pointer}
    .small{font-size:13px;color:#6b7280}
    .actions{display:flex;gap:6px;justify-content:flex-start}
    .btn{background:var(--blue);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid #e6e9ef;color:#333}
    .note{font-size:13px;color:#6b7280;margin-top:6px}
    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:60}
    .modal .box{background:#fff;padding:12px;border-radius:10px;max-width:90%;max-height:90%;display:flex;flex-direction:column;gap:8px}
    .modal img{max-width:100%;max-height:70vh;border-radius:6px}
    /* responsive */
    @media (max-width:900px){ .sidebar{display:none} main{margin-left:0;padding:12px} header{padding:0 10px} }
  </style>
</head>
<body>
  <header>
    <div class="brand">TOP VIEW — النظام الإداري</div>
    <div class="small">Dashboard</div>
    <div style="margin-left:auto" id="userInfo" class="small"></div>
  </header>

  <div class="layout">
    <aside class="sidebar" id="sidebar">
      <h4>قوائم المصنع</h4>
      <!-- القوائم المستخرجة من الاكسل (حسب طلبك) -->
      <button class="side-btn" data-page="employees">بيانات الموظفين</button>
      <button class="side-btn" data-page="attendance">الحضور والانصراف</button>
      <button class="side-btn" data-page="dailyTasks">المهام اليومية</button>
      <button class="side-btn" data-page="projects">متابعة المشاريع</button>
      <button class="side-btn" data-page="materials">المواد والمخزون</button>
      <button class="side-btn" data-page="equipment">المعدات</button>
      <button class="side-btn" data-page="maintenance">الصيانة</button>
      <button class="side-btn" data-page="adminNotes">ملاحظات إدارية</button>
      <button class="side-btn" data-page="finance">الإيرادات والمصروفات</button>
      <div style="flex:1"></div>
      <button class="side-btn" id="logoutBtn">تسجيل خروج</button>
      <div class="note">اضغط على أي صفحة لعرض الجدول الخاص بها. التعديل مباشر — اكتب واغمض الخلية للحفظ.</div>
    </aside>

    <main>
      <div class="topbar">
        <div>
          <input id="searchBox" class="search" placeholder="بحث في الصفحة الحالية..." />
        </div>
        <div class="small">الصفحة: <span id="pageTitle">—</span></div>
      </div>

      <div id="content"></div>
    </main>
  </div>

  <!-- image modal -->
  <div id="imgModal" class="modal" onclick="closeModal()">
    <div class="box" onclick="event.stopPropagation()">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="small">صورة الفاتورة</div>
        <div>
          <a id="downloadLink" class="btn" href="#" download>تحميل</a>
          <button onclick="closeModal()" class="btn ghost">إغلاق</button>
        </div>
      </div>
      <img id="modalImage" src="" alt="invoice"/>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
  // ================== CONFIG ==================
  const firebaseConfig = {
    apiKey: "AIzaSyCEpRw7F829fqzPZAphqJ2wOe3xUDJWLtw",
    authDomain: "topview-system.firebaseapp.com",
    projectId: "topview-system",
    storageBucket: "topview-system.appspot.com",
    messagingSenderId: "1073945877413",
    appId: "1:1073945877413:web:d516e451e543f7a9db664c",
    measurementId: "G-EPVZGH6Y2G"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // ================== state ==================
  let currentPage = 'employees';
  const pageCollections = {
    employees: 'employees',
    attendance: 'attendance',
    dailyTasks: 'daily_tasks',
    projects: 'projects',
    materials: 'materials',
    equipment: 'equipment',
    maintenance: 'maintenance',
    adminNotes: 'admin_notes',
    finance: 'finance'
  };

  // keep local cache of docs per page
  const cache = {};
  Object.keys(pageCollections).forEach(k=> cache[k]=[]);

  // initial user info (simple admin login used before)
  let user = null;

  // ================== helpers ==================
  function q(sel, root=document) { return root.querySelector(sel); }
  function el(tag, attrs={}, ...kids){ const e=document.createElement(tag); for(const k in attrs){ if(k.startsWith('on')) e.addEventListener(k.substring(2), attrs[k]); else e.setAttribute(k, attrs[k]); } kids.forEach(c=> typeof c==='string' ? e.appendChild(document.createTextNode(c)) : c && e.appendChild(c)); return e; }

  function showPageTitle(name){ q('#pageTitle').textContent = name; }

  // ================== modal ==================
  function openModal(url){
    q('#modalImage').src = url;
    q('#downloadLink').href = url;
    q('#imgModal').style.display = 'flex';
  }
  function closeModal(){ q('#imgModal').style.display = 'none'; q('#modalImage').src=''; q('#downloadLink').href='#'; }

  // ================== Auth (simple) ==================
  function showLoginPrompt(){
    // simple prompt login (keeps same UX you had)
    const email = prompt('Email:','admin@topview.com');
    const pass = prompt('Password:','123456');
    if(email === 'admin@topview.com' && pass === '123456'){
      user = {email};
      q('#userInfo').textContent = email;
      // attach listeners
      attachAllListeners();
      renderCurrent();
    } else {
      alert('خطأ فى بيانات الدخول');
      showLoginPrompt();
    }
  }

  // ================== Attach realtime listeners ==================
  function attachAllListeners(){
    Object.keys(pageCollections).forEach(page=>{
      const col = pageCollections[page];
      db.collection(col).orderBy('createdAt','asc').onSnapshot(snap=>{
        cache[page] = snap.docs.map(d=> ({ id: d.id, ...d.data() }) );
        if(page===currentPage) renderCurrent();
      });
    });
  }

  // ================== Renderers ==================
  // renders table for page with columns based on page
  function renderCurrent(){
    showPageTitle(getPageLabel(currentPage));
    q('#searchBox').value = '';
    q('#content').innerHTML = '';
    const container = el('div',{class:'card'});
    container.appendChild(el('h3',{}, getPageLabel(currentPage)));
    // search handler
    q('#searchBox').oninput = ()=> filterTable(q('table.table-page'));

    // build table based on page
    const table = buildTableFor(currentPage);
    table.classList.add('table-page');
    container.appendChild(table);
    q('#content').appendChild(container);
  }

  function getPageLabel(key){
    const labels = {
      employees: 'بيانات الموظفين',
      attendance: 'الحضور والانصراف',
      dailyTasks: 'المهام اليومية',
      projects: 'متابعة المشاريع',
      materials: 'المواد والمخزون',
      equipment: 'المعدات',
      maintenance: 'الصيانة',
      adminNotes: 'ملاحظات إدارية',
      finance: 'الإيرادات والمصروفات'
    };
    return labels[key] || key;
  }

  // filter rows by search input
  function filterTable(table){
    const qv = q('#searchBox').value.trim().toLowerCase();
    if(!table) return;
    Array.from(table.tBodies[0].rows).forEach(row=>{
      row.style.display = row.innerText.toLowerCase().includes(qv) ? '' : 'none';
    });
  }

  // build table with columns according to page schema
  function buildTableFor(page){
    // define schema per page: array of {key,label,editable, type}
    const schemas = {
      employees: [
        {k:'empId',l:'ID',e:true},
        {k:'name',l:'Name',e:true},
        {k:'role',l:'Role',e:true},
        {k:'phone',l:'Phone',e:true},
        {k:'salary',l:'Salary',e:true},
        {k:'notes',l:'Notes',e:true},
        {k:'invoice',l:'Invoice',e:false, type:'file'}
      ],
      attendance: [
        {k:'empName',l:'Employee',e:true},
        {k:'date',l:'Date',e:true},
        {k:'checkIn',l:'Check In',e:true},
        {k:'checkOut',l:'Check Out',e:true},
        {k:'notes',l:'Notes',e:true},
        {k:'invoice',l:'Attachment',e:false, type:'file'}
      ],
      dailyTasks: [
        {k:'date',l:'Date',e:true},
        {k:'task',l:'Task',e:true},
        {k:'assignedTo',l:'Assigned To',e:true},
        {k:'status',l:'Status',e:true},
        {k:'notes',l:'Notes',e:true},
        {k:'invoice',l:'Attachment',e:false, type:'file'}
      ],
      projects: [
        {k:'projectName',l:'Project',e:true},
        {k:'client',l:'Client',e:true},
        {k:'status',l:'Status',e:true},
        {k:'budget',l:'Budget',e:true},
        {k:'startDate',l:'Start Date',e:true},
        {k:'notes',l:'Notes',e:true},
        {k:'invoice',l:'Files',e:false, type:'file'}
      ],
      materials: [
        {k:'item',l:'Item',e:true},
        {k:'qty',l:'Quantity',e:true},
        {k:'unitPrice',l:'Unit Price',e:true},
        {k:'total',l:'Total',e:false},
        {k:'location',l:'Location',e:true},
        {k:'notes',l:'Notes',e:true},
        {k:'invoice',l:'Invoice',e:false, type:'file'}
      ],
      equipment: [
        {k:'name',l:'Equipment',e:true},
        {k:'model',l:'Model',e:true},
        {k:'serial',l:'Serial',e:true},
        {k:'status',l:'Status',e:true},
        {k:'notes',l:'Notes',e:true},
        {k:'invoice',l:'Docs',e:false, type:'file'}
      ],
      maintenance: [
        {k:'date',l:'Date',e:true},
        {k:'equipment',l:'Equipment',e:true},
        {k:'issue',l:'Issue',e:true},
        {k:'cost',l:'Cost',e:true},
        {k:'status',l:'Status',e:true},
        {k:'invoice',l:'Invoice',e:false, type:'file'}
      ],
      adminNotes: [
        {k:'date',l:'Date',e:true},
        {k:'title',l:'Title',e:true},
        {k:'details',l:'Details',e:true},
        {k:'author',l:'Author',e:true},
        {k:'invoice',l:'Attachment',e:false, type:'file'}
      ],
      finance: [
        {k:'type',l:'Type',e:true},
        {k:'date',l:'Date',e:true},
        {k:'quantity',l:'Quantity',e:true},
        {k:'price',l:'Price',e:true},
        {k:'total',l:'Total',e:false},
        {k:'notes',l:'Notes',e:true},
        {k:'invoice',l:'Invoice',e:false, type:'file'}
      ]
    };

    const schema = schemas[page] || [{k:'col1',l:'Col 1',e:true}];

    const tbl = el('table',{});
    const thead = el('thead',{});
    const headRow = el('tr',{});
    schema.forEach(col=>{
      headRow.appendChild(el('th',{}, col.l));
    });
    thead.appendChild(headRow);
    tbl.appendChild(thead);

    const tbody = el('tbody',{});
    // render existing docs
    (cache[page]||[]).forEach(doc=>{
      tbody.appendChild(buildRow(page, schema, doc));
    });
    // always add an empty "new" row at bottom for adding inline
    tbody.appendChild(buildRow(page, schema, {__new:true}));
    tbl.appendChild(tbody);
    return tbl;
  }

  // build a row (doc may contain id and fields); if __new -> empty editable row
  function buildRow(page, schema, doc){
    const tr = el('tr',{});
    const isNew = !!doc.__new;
    const id = doc.id || null;

    schema.forEach(col=>{
      const td = el('td',{});
      if(col.type === 'file'){
        // file column: show thumbnail if url present, and upload input
        const imgWrap = el('div',{style:'display:flex;gap:8px;align-items:center;justify-content:flex-start'});
        const thumb = el('img',{class:'thumbnail', src: doc[col.k] ? doc[col.k] : '', alt:''});
        thumb.style.display = doc[col.k] ? 'inline-block' : 'none';
        thumb.onclick = ()=> openModal(doc[col.k]);
        imgWrap.appendChild(thumb);

        // uploader small input (hidden) and visible label
        const input = el('input',{type:'file', accept:'image/*', style:'display:none'});
        input.onchange = async (ev)=>{
          const f = ev.target.files[0];
          if(!f) return;
          const path = `${page}/${Date.now()}_${Math.random().toString(36).slice(2,6)}_${f.name.replace(/\s+/g,'_')}`;
          const ref = storage.ref(path);
          await ref.put(f);
          const url = await ref.getDownloadURL();
          // update doc: if new row -> create; else update
          if(isNew){
            // collect other fields in this new row
            const rowObj = collectRowData(tr, schema);
            rowObj[col.k] = url;
            rowObj.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            const added = await db.collection(pageCollections[page]).add(rowObj);
            // refresh handled by snapshot listener, but directly update thumb
            input.value = '';
          } else {
            await db.collection(pageCollections[page]).doc(id).update({ [col.k]: url });
          }
        };

        const label = el('label',{class:'file-uploader'}, 'رفع صورة');
        label.onclick = ()=> input.click();
        imgWrap.appendChild(input);
        imgWrap.appendChild(label);
        td.appendChild(imgWrap);
      } else if(col.e){
        // editable cell
        const initial = isNew ? '' : (doc[col.k] !== undefined ? doc[col.k] : '');
        const div = el('div',{contenteditable:true, 'data-key':col.k, 'data-id': id || '', style:'min-width:100px;'}, initial);
        // save on blur
        div.addEventListener('blur', async (ev)=>{
          const val = ev.target.textContent.trim();
          // if new row: create document with values (only if any field filled)
          if(isNew){
            // collect row object from all editable cells
            const rowData = collectRowData(tr, schema);
            // check if at least one non-empty (besides invoice)
            const has = Object.keys(rowData).some(k=> rowData[k] !== '' && rowData[k] !== null && rowData[k] !== undefined);
            if(has){
              rowData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
              // for computed fields like total: compute here if schema has qty & price
              if(page==='finance'){
                const qv = parseFloat(rowData['quantity']||0) || 0;
                const pv = parseFloat(rowData['price']||0) || 0;
                rowData['total'] = (qv*pv).toFixed(2);
              }
              await db.collection(pageCollections[page]).add(rowData);
              // after adding, snapshot will re-render table
            }
          } else {
            // update single field
            const updateObj = {};
            updateObj[col.k] = val;
            // if finance and quantity/price changed => update total
            if(page==='finance' && (col.k === 'quantity' || col.k === 'price')){
              const docCache = cache[page].find(x=> x.id === id) || {};
              const other = (col.k==='quantity') ? parseFloat(val||0) : parseFloat(docCache['quantity']||0);
              const other2 = (col.k==='price') ? parseFloat(val||0) : parseFloat(docCache['price']||0);
              updateObj['total'] = ( (col.k==='quantity'?other:parseFloat(docCache['quantity']||0)) * (col.k==='price'?other2:parseFloat(docCache['price']||0)) ).toFixed(2);
            }
            await db.collection(pageCollections[page]).doc(id).update(updateObj);
            // if user cleared all editable fields -> delete doc
            const updated = await db.collection(pageCollections[page]).doc(id).get();
            const data = updated.data() || {};
            const keys = schema.filter(c=>c.e).map(c=>c.k);
            const allEmpty = keys.every(k=> (data[k] === '' || data[k] === null || data[k] === undefined) );
            if(allEmpty){
              await db.collection(pageCollections[page]).doc(id).delete();
            }
          }
        });
        // press Enter to finish edit
        div.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); div.blur(); } });
        td.appendChild(div);
      } else {
        // non-editable display (computed or plain)
        if(!isNew){
          if(col.k === 'total' && page==='materials'){
            // compute total if missing
            const qty = parseFloat(doc['qty']||0)||0;
            const price = parseFloat(doc['unitPrice']||0)||0;
            td.appendChild(document.createTextNode( (qty*price).toFixed(2) ));
          } else if(col.k === 'total' && page==='finance'){
            const total = doc['total'] !== undefined ? doc['total'] : ((parseFloat(doc['quantity']||0)||0)*(parseFloat(doc['price']||0)||0)).toFixed(2);
            td.appendChild(document.createTextNode(total));
          } else {
            td.appendChild(document.createTextNode(doc[col.k] || ''));
          }
        } else {
          td.appendChild(document.createTextNode(''));
        }
      }
      tr.appendChild(td);
    });

    return tr;
  }

  // collect current row's editable values into object (used when creating new doc)
  function collectRowData(tr, schema){
    const obj = {};
    const cells = Array.from(tr.children);
    schema.forEach((col, i)=>{
      if(col.type === 'file') {
        // file will be handled separately
      } else if(col.e){
        const div = cells[i].querySelector('[contenteditable]');
        obj[col.k] = div ? div.textContent.trim() : '';
      } else {
        // non-editable: leave empty (or compute after)
      }
    });
    // compute totals for finance or materials
    if(schema.some(s=>s.k==='total') && schema.some(s=>s.k==='quantity') && schema.some(s=>s.k==='price')){
      const qv = parseFloat(obj['quantity']||0)||0;
      const pv = parseFloat(obj['price']||0)||0;
      obj['total'] = (qv*pv).toFixed(2);
    }
    return obj;
  }

  // ================== Sidebar actions ==================
  document.querySelectorAll('.side-btn').forEach(b=>{
    b.addEventListener('click', ()=> {
      document.querySelectorAll('.side-btn').forEach(x=> x.classList.remove('active'));
      b.classList.add('active');
      currentPage = b.dataset.page;
      renderCurrent();
    });
  });
  q('#logoutBtn').addEventListener('click', ()=>{
    if(confirm('Logout?')){ user=null; q('#userInfo').textContent=''; showLoginPrompt(); }
  });

  // search box behavior: will be assigned when rendering page

  // ================== Start ==================
  // start login and listeners
  showLoginPrompt();

  </script>
</body>
</html>
